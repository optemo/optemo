<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
       "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<script type="text/javascript" src="/javascripts/json2.js"></script>
<script type="text/javascript" src="/javascripts/easyXDM.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
<script type="text/javascript">

// Set up socket here
var local_socket = new easyXDM.Rpc(/** The channel configuration*/{
    local: "name.html"
}, /** The configuration */ {
    remote: {
		// These three parsing functions get declared on the other side of the socket, in /public/optemo_embedder.js
        initialPageDelivery: {},
		parseData: {},
		parseDataThin: {}
    },
    local: {
		initialLoad: function() {
			// This gets the optemo.html.erb layout, passing the scripts, stylesheets, etc., back to set the stage for later ajax calls.
            var urlVars = (function() {
                var vars = [], hash;
                var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
                for(var i = 0; i < hashes.length; i++)
                {
                    hash = hashes[i].split('=');
                    vars.push(hash[0]);
                    vars[hash[0]] = hash[1];
                }
                return vars;
            })();
			$.ajax({type: "GET",
				data: "",
				url: (urlVars["serverName"] !== undefined ? ("http://" + unescape(urlVars["serverName"])) : "http://ast0.optemo.com/") + "?embedding=true",
				success: function(data) {
					local_socket.initialPageDelivery(data);
				},
				error: function(xhr, status, error) {
//				    console.log(xhr.responseText);
//				    console.log(status);
//				    console.log(error);
					local_socket.initialPageDelivery();// passed data before, but not sure this does anything.
				}
			});
		},
		quickiframecall: function(element_name, myurl, fn) {
			// This is for simple $('#element').load functionality. Useful for "show" page at the moment, maybe other things in future.
			$.ajax({type: "GET", 
				url: myurl, 
				success: function(data) {local_socket.parseDataThin(element_name, data, fn);}, 
				error: function(data) {local_socket.parseDataThin(element_name, data, fn);}
			});
		},
        iframecall: function(hash, myurl, mydata, fn, fnError){
			// This is a standard ajax call, with the same code as optemo_module.ajaxsend, located in application.js.
	    	if (myurl != null) {
	        	$.ajax({
	        		type: (mydata==null)?"GET":"POST",
	        		data: (mydata==null)?"":mydata,
	        		url: myurl,
		    		success: function(data) {local_socket.parseData(data);},
					error: function(data) {local_socket.parseData(data);}
	        	});
	    	} else if (typeof(hash) != "undefined" && hash != null) {
	    		$.ajax({
	    			type: "GET",
	    			url: "/compare/?ajax=true&hist="+hash,
		    		success: function(data) {local_socket.parseData(data);},
					error: function(data) {local_socket.parseData(data);}
	    		});
	    	}
            return; // The ajax thread will call the other side of the socket when the ajax call is done, so we return nothing here.
        }
    }
});

</script>
</head>
<body>
<div id="ajaxreturnvalue"><!-- There should never be anything in here. --></div>
</body>
</html>
